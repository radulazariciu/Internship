//>>built
define("epi-ecf-ui/contentediting/editors/AssociationCollectionEditor",["dojo/_base/array","dojo/aspect","dojo/_base/declare","dojo/Deferred","dojo/dom-construct","dojo/_base/lang","dojo/Stateful","dojo/when","dojo/topic","dijit/_TemplatedMixin","dijit/_Widget","dgrid/editor","dgrid/OnDemandGrid","dgrid/Selection","epi/shell/_ContextMixin","epi/shell/dgrid/_EditorMetadataMixin","epi/shell/widget/_FocusableMixin","epi/shell/widget/_ModelBindingMixin","epi/shell/command/builder/ButtonBuilder","epi/shell/widget/dialog/Confirmation","epi/dependency","epi/string","epi-cms/contentediting/editors/_AddItemDialogMixin","epi-cms/core/ContentReference","epi-cms/widget/ContentSelectorDialog","epi-cms/dgrid/formatters","epi-cms/dgrid/WithContextMenu","epi-cms/dgrid/DnD","../viewmodel/AssociationCollectionEditorModel","../../store/CompositeKey","./LinkEditEditor","./_CollectionEditorDndMixin","../../dgrid/_ClickablePathColumnMixin","../ModelSupport","epi/i18n!epi/cms/nls/commerce.contentediting.editors.associationcollectioneditor","epi/i18n!epi/nls/episerver.shared"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,DnD,_1c,_1d,_1e,_1f,_20,_21,_22,_23){var _24=_3([_b,_a,_12,_17,_11,_1f,_f],{templateString:"<div>                            <div data-dojo-attach-point=\"commandTargetNode\"></div>                            <div data-dojo-attach-point=\"overlayDnd\">                                <div class=\"epi-associationCollectionEditor\" data-dojo-attach-point=\"gridNode\"></div>                            </div>                        </div>",grid:null,gridOverlayClass:"epi-grid-dnd-overlay",modelType:_1c,itemType:"EPiServer.Commerce.AddOns.UI.Rest.Models.AssociationModel",allowedDndTypes:[_21.contentTypeIdentifier.entryContentBase,_21.linkTypeIdentifier.association],includedColumns:["ContentTypeIdentifier","Name","Code","Path","GroupName"],editableColumns:["GroupName"],cellActionName:"epiGridAction",itemEditorType:_19,postMixInProperties:function(){this.model=this.model||new this.modelType({itemType:this.itemType});},postCreate:function(){this.inherited(arguments);if(!this.roots){var _25=_15.resolve("epi.cms.contentRepositoryDescriptors"),_26=_25.catalog;this.roots=_26.roots;}var _27=new _13({settings:{showLabel:true}}),_28=this.model.getListCommand();_27.create(_28,this.commandTargetNode);var _29=_3([_d,_e,_c,_10,_1b,DnD,_20],{});_8(this.model.metadataManager.getMetadataForType(this.itemType),_6.hitch(this,function(_2a){var _2b=[{field:"contentTypeIdentifier",renderHeaderCell:function(){},get:function(_2c){return _2c.contentTypeIdentifier;},label:"",formatter:_1a.contentIcon,className:"epi-columnIcon16x16",sortable:false},{field:this.cellActionName,renderHeaderCell:function(){},renderCell:_6.hitch(this,function(_2d,_2e,_2f,_30){var _31=new _13({settings:{showLabel:false}}),_32=this.model.getCommands(this.grid,null);_1.forEach(_32,function(_33){_31.create(_33,_2f);});}),className:"epi-columnNarrow",sortable:false}],_34=["groupName","type"],_35=new _1d(_15.resolve("epi.storeregistry").get("epi.commerce.association"),_34,true),_36=this.grid=new _29({store:_35,minWidth:100,noDataMessage:_22.nodatamessage,selectionMode:"single","class":"epi-plain-grid epi-plain-grid-modal epi-plain-grid--margin-bottom epi-plain-grid--cell-borders",columns:_2b,metadata:{properties:_2a.properties,gridIncluded:this.includedColumns,gridEditable:this.editableColumns},dndSourceTypes:[_21.linkTypeIdentifier.association],dndParams:{copyOnly:true,accept:this.allowedDndTypes||[],creator:_6.hitch(this,this._dndNodeCreator)}});_5.place(this.grid.domNode,this.gridNode);this.own(_36,_35,_2.after(_35,"removeReAdd",function(_37){_8(_37,function(){_36.refresh();});}),this.model.on("itemAdded",_6.hitch(this,function(){this.grid.refresh();})),this.model.on("itemSaved",_6.hitch(this,function(){this.grid.refresh();})),this.model.on("itemRemoved",_6.hitch(this,function(){this.grid.refresh();})),this.model.watch("contentLink",_6.hitch(this,function(_38,_39,_3a){if(_39!==_3a){this._updateGridQuery(_3a);_36.resize();}})),this.model.on("removeCommandEvent",_6.hitch(this,function(){_8(this._showConfirmation(_22.deleteconfirmation.title,_22.deleteconfirmation.description),_6.hitch(this,function(){if(this.model){var _3b=[];for(var _3c in this.grid.selection){if(this.grid.selection.hasOwnProperty(_3c)){_3b.push(this.model.store.get(_3c));}}return this.model.removeItems(_3b);}}));})));this._setupDnD();_8(this.getCurrentContext(),_6.hitch(this,function(_3d){this._updateGridQuery(_3d.id);this.grid.startup();}));}));},_updateGridQuery:function(_3e){this.grid.set("query",{referenceId:new _18(_3e).createVersionUnspecificReference().toString()});},_addItem:function(_3f){_8(this._dndGetItemData(_3f),_6.hitch(this,function(_40){if(_40){return this.model.addItem(_40);}}));},_noDataMessage:_22.nodatamessage,resize:function(){this.inherited(arguments);if(this.grid){this.grid.resize();}},_getDialogTitleText:function(){return _22.addlabel;},_createItemEditor:function(){return new this.itemEditorType({canSelectOwnerContent:false,showButtons:false,roots:this.roots,allowedTypes:[_21.contentTypeIdentifier.entryContentBase],showAllLanguages:false});},_dndGetItemData:function(_41){return _8(_41.data,_6.hitch(this,function(_42){if(_42){return this._createItem(_42.contentLink,_42.name);}}));},_createItem:function(_43,_44){return {name:_44||_43,sortOrder:0,source:this.model.get("contentLink"),target:_43};},onExecuteDialog:function(){var _45=this._itemEditor.get("value");this._addItem({data:{contentLink:_45}},true);},_setValueAttr:function(_46){this._set("value",_46);if(this.model){this.model.set("contentLink",_46);}},destroy:function(){if(this.grid){this.grid.destroy();this.grid=null;}this.inherited(arguments);},_showConfirmation:function(_47,_48){var _49=new _4();var _4a=new _14({destroyOnHide:true,title:_16.toHTML(_47),description:_16.toHTML(_48),onAction:function(_4b){if(_4b){_49.resolve();}else{_49.cancel();}}});_4a.show();return _49.promise;}});return _3([_1e],{resources:_22,gridCollectionType:_24,executeAction:function(_4c){_9.publish("/epi/layout/pinnable/tools/toggle",true);}});});