//>>built
define("epi-ecf-ui/widget/viewmodel/CatalogTreeStoreModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/promise/all","dojo/request","dojo/when","dojo/topic","epi/dependency","epi/routes","epi/string","epi/shell/widget/dialog/Alert","epi/shell/widget/dialog/Dialog","epi/shell/TypeDescriptorManager","epi-cms/core/ContentReference","epi-cms/widget/ContentForestStoreModel","../../contentediting/ModelSupport","../CatalogPasteItemDialog","epi/i18n!epi/nls/commerce.components.catalogtree"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13){return _2([_10],{relationStore:null,typeDescriptorManager:_e,constructor:function(){this.relationStore=this.relationStore||_9.resolve("epi.storeregistry").get("epi.commerce.relation");this.contentTypeStore=this.contentTypeStore||_9.resolve("epi.storeregistry").get("epi.cms.contenttype");this._handles.push(_8.subscribe("relationChanged",_3.hitch(this,this._relationChanged)));},_relationChanged:function(_14){this._childrenChanged(_14.target);},newItems:function(_15,_16){this._selectAction(_15,_16);},newItem:function(_17,_18,_19){this._performAction(_17,_18,_19);},pasteItems:function(_1a,_1b){this._selectAction(_1a,_1b);},pasteItem:function(_1c,_1d,_1e,_1f){if(typeof _1f==="string"){if(!_1c||!_1e){return;}switch(_1f){case "link":return this._addRelation(_1c,_1e);case "move":if(_f.compareIgnoreVersion(_1c.parentLink,_1d.contentLink)){return this.inherited(arguments,[_1c,_1d,_1e,false]);}else{return this._replaceRelation(_1c,_1d,_1e);}break;case "duplicate":return this.inherited(arguments,[_1c,_1d,_1e,true]);default:break;}}},_selectAction:function(_20,_21){var _22=function(_23,_24){return _1.every(_23,function(_25){if(!_25.dndData||!_25.dndData.data){return false;}return _24.indexOf(_25.dndData.data.contentTypeID)>-1;});};return _7(this._isContentTypeAllowed(_20,_21,_22),_3.hitch(this,function(_26){if(!_26){this._showContentTypeAlert();return false;}var _27=this._isLinkSupported(_21.typeIdentifier);return _7(this._newItemConfirmation(false,!_27),_3.hitch(this,function(_28){var _29=_1.map(_20,function(_2a){return this._performAction(_2a,_21,_28);},this);return _5(_29);}));}));},_showContentTypeAlert:function(_2b){if(this._invalidContentTypeAlertDialog){this._invalidContentTypeAlertDialog.destroy();}this.own(this._invalidContentTypeAlertDialog=new _c({destroyOnHide:true,description:_b.toHTML(_13.contenttypesnotallowed)}));this._invalidContentTypeAlertDialog.show();},_performAction:function(_2c,_2d,_2e){var _2f=_2c.dndData.data;if(_2f){var _30=this.getParentItem(_2c.dndData);return this.pasteItem(_2f,_30,_2d,_2e);}},getParentItem:function(_31){if(_31&&_31.options&&_31.options.oldParentItem){return _31.options.oldParentItem;}throw "The item is not supported. The drag source must specify options containing the oldParentItem.";},_newItemConfirmation:function(_32,_33){var _34=new _4();var _35=new _12({hideMoveOption:_32,hideLinkOption:_33,executeDialog:function(_36){_34.resolve(_36);},cancelDialog:function(){_34.cancel();}});var _37=new _d({dialogClass:"epi-dialog-confirm",defaultActionsVisible:false,content:_35,title:_35.title,destroyOnHide:true});_37.show();return _34.promise;},_selectItemOnPasteComplete:function(_38,_39,_3a,_3b,_3c){},_getRelations:function(_3d){return this.relationStore.query({referenceId:_3d});},_addRelation:function(_3e,_3f){return _7(this._getRelations(_3e.contentLink),_3.hitch(this,function(_40){var _41=0;_1.forEach(_40,function(_42){if(_42.sortOrder>_41){_41=_42.sortOrder;}});return _7(this.relationStore.add({source:_3e.contentLink,target:_3f.contentLink,type:_11.relationType.node,sortOrder:_41+100}),function(_43){_8.publish("relationChanged",_43);});}));},_replaceRelation:function(_44,_45,_46){return _7(this._getRelations(_44.contentLink),_3.hitch(this,function(_47){_1.forEach(_47,function(_48){if(_48.type==_11.relationType.node&&_f.compareIgnoreVersion(_48.target,_45.contentLink)){var _49={source:_44.contentLink,target:_46.contentLink,type:_11.relationType.node,sortOrder:_48.sortOrder};return _7(this.relationStore.remove(_48.id),_3.hitch(this,function(){return _7(this.relationStore.add(_49),function(_4a){_8.publish("relationChanged",_4a);});}));}},this);}));},copy:function(_4b,_4c){return _7(this._isContentTypeAllowed(_4b,_4c),_3.hitch(this,function(_4d){if(!_4d){this._showContentTypeAlert();return;}var _4e=this._isLinkSupported(_4c.typeIdentifier);return _7(this._newItemConfirmation(true,!_4e),_3.hitch(this,function(_4f){var _50=_1.map(_4b,function(_51){return _7(this.store.get(_51.data.parentLink),_3.hitch(this,function(_52){return this.pasteItem(_51.data,_52,_4c,_4f);}));},this);return _5(_50).then(_3.hitch(this,function(_53){_8.publish("itemPasted",_53);}));}));}));},_isContentTypeAllowed:function(_54,_55,_56){return _7(this.contentTypeStore.query({query:"getavailablecontenttypes",parentReference:_55.contentLink}),_3.hitch(this,function(_57){var _58=_1.map(_57,function(_59){return _59.id;});if(!_56){_56=function(_5a,_5b){return _1.every(_5a,function(_5c){if(!_5c.data){return false;}return _5b.indexOf(_5c.data.contentTypeID)>-1;});};}return _56(_54,_58);}));},move:function(_5d,_5e){if(!_5e.contentLink){_5e=this.store.get(_5e);}return _7(this._isContentTypeAllowed(_5d,_5e),_3.hitch(this,function(_5f){if(!_5f){this._showContentTypeAlert();return;}var _60=_1.map(_5d,function(_61){if(_61.data){var _62={contentLink:new _f(_61.data.parentLink).createVersionUnspecificReference().toString()};return this.pasteItem(_61.data,_62,_5e,"move");}},this);return _5(_60).then(_3.hitch(this,function(_63){_8.publish("itemPasted",_63);}));}));},onDeleted:function(_64){_8.publish("catalogContentDeleted",_64);},remove:function(_65){var _66=_a.getActionPath({moduleArea:"episerver.commerce.addons.ui",controller:"Delete",action:"Delete"}),_67=_1.map(_65,function(_68){return _68.data.contentLink;}),_69=_6.post(_66,{data:{contentReferences:_67}});return _7(_69,_3.hitch(this,function(){return _7(this.currentContentService.getCurrentContext(),_3.hitch(this,function(_6a){_1.some(_65,function(_6b){if(_f.compareIgnoreVersion(_6a.id,_6b.data.contentLink)&&_6b.data.parentLink){this.onSelect(_6b.data.parentLink,true);return true;}},this);var _6c=_1.map(_67,function(_6d){return this.store.refresh(_6d);},this);return _7(_5(_6c),_3.hitch(this,function(){this.onDeleted(_65);}));}));}));},_isLinkSupported:function(_6e){return this.typeDescriptorManager.isBaseTypeIdentifier(_6e,_11.contentTypeIdentifier.entryContentBase)||this.typeDescriptorManager.isBaseTypeIdentifier(_6e,_11.contentTypeIdentifier.nodeContent);},isSupportedType:function(_6f){var _70=this.inherited(arguments);var _71=_1.some(this.containedTypes,function(_72){return this.typeDescriptorManager.isBaseTypeIdentifier(_6f,_72);},this);return _70||_71;}});});